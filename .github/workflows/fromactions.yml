name: LLM Endpoint Security Testing

on:
  workflow_dispatch:

jobs:
  llm-pentest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run AI Security Scanner
        uses: tonyAllTrue/ai-security-posture-management-scanner@v0.0.10
        with:
          # ========================================
          # REQUIRED: Core Authentication
          # ========================================
          alltrue-api-key: ${{ secrets.ALLTRUE_API_KEY }}
          alltrue-api-url: ${{ vars.ALLTRUE_API_URL }}
          alltrue-customer-id: ${{ vars.ALLTRUE_CUSTOMER_ID }}
          alltrue-organization-name: ${{ vars.ALLTRUE_ORGANIZATION_NAME }}
          # alltrue-organization-id: ''
          
          # ========================================
          # Execution Toggles
          # ========================================
          enable-llm-pentest: true
          enable-model-scanning: true
          
          # ========================================
          # Inventory Scope
          # ========================================
          inventory-scope: 'project'
          # project-ids: ''
          project-names: '2nd Project'
          # target-resource-ids: ''
          target-resource-names: '*.pkl*,file:exploit.py,repo:IHasFarms/MaliciousModel,*API Key*'
          
          # ========================================
          # LLM Pentest: Basic Configuration
          # ========================================
          pentest-template: 'Prompt Injection'
          pentest-num-attempts: 5
          
          # ========================================
          # LLM Pentest: Advanced Configuration
          # ========================================
          # Model Selection
          pentest-model-mapping:  'OpenAIEndpoint:gpt-4,AnthropicEndpoint:claude-3-opus-20240229,BedrockEndpoint:anthropic.claude-3-sonnet-20240229-v1:0,GoogleAIEndpoint:gemini-pro'
          
          # Guardrails
          pentest-apply-guardrails: true
          
          # System Prompts
          pentest-system-prompt-enabled: true
          pentest-system-prompt-text: |
            You are an AI assistant. Be helpful and harmless.
          pentest-cleanup-system-prompt: true
          
          # Capture-Replay Datasets
          pentest-dataset-enabled: false
          # pentest-dataset-id: ''
          # pentest-dataset-name: 'TonysTestDataset'
          # pentest-cleanup-dataset: false

          # ========================================
          # Model Scanning Configuration
          # ========================================
          model-scan-description: 'Weekly Comprehensive Security Audit - Stress Test'
          model-scan-policies: 'model-scan-malware-signatures-prohibited,model-custom-layers-prohibited'
          
          # ========================================
          # HuggingFace Model Onboarding
          # ========================================
          huggingface-onboarding-enabled: true
          huggingface-models-to-onboard: 'LGAI-EXAONE/K-EXAONE-236B-A23B,Lightricks/LTX-2'
          # huggingface-onboarding-project-id: ''
          huggingface-onboarding-wait-secs: 25
          huggingface-onboarding-only: false
          
          # ========================================
          # Failure Thresholds & Actions
          # ========================================
          fail-outcome-at-or-above: ''
          on-threshold-action: 'issue'
          on-hard-failures-action: 'ignore'
          
          # ========================================
          # GitHub Issues Integration
          # ========================================
          github-token: ${{ secrets.GH_TOKEN }}
          github-repository: ${{ github.repository }}
          github-default-labels: 'weekly-audit,stress-test,comprehensive'
          github-assignees: 'TonyPurple'
          category-issue-min-severity: 'HIGH'
          
          # ========================================
          # Concurrency & Performance
          # ========================================
          max-concurrent-pentests: 30
          start-stagger-secs: 1
          max-start-retries: 6
          start-retry-delay: 20
          
          # ========================================
          # Polling Configuration
          # ========================================
          poll-timeout-secs: 14400
          poll-timeout-action: 'continue'
          graphql-poll-interval-secs: 90
          
          # ========================================
          # Misc
          # ========================================
          python-version: '3.11'
          artifact-retention-days: 30
          source-ref: 'main'
